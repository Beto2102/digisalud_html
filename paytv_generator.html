<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>AZ Content - Catálogo</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script> -->
    <script src="jsoneditor.min.js"></script>
    <link rel="stylesheet" href="themes/default.min.css" type="text/css" media="all" />
    <script type="text/javascript" src="jquery.sceditor.xhtml.min.js"></script>
    <!-- <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"> -->
    <link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/slate/bootstrap.min.css" rel="stylesheet" integrity="sha384-RpX8okQqCyUNG7PlOYNybyJXYTtGQH+7rIKiVvg1DLg6jahLEk47VvpUyS+E2/uJ" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <script src="sha1.js"></script>
    <script>
        if (!sessionStorage.getItem("logged")) {
            window.location.href = "index.html";
        }
    </script>

</head>

<body style="padding: 20px;">
    <ul class="nav nav-tabs">
        <li role="presentation"><a href="news_generator.html">Noticias</a></li>
        <li role="presentation"><a href="catalog_generator.html">Catálogo</a></li>
        <li role="presentation"><a href="team_generator.html">SalesTeam</a></li>
        <li role="presentation"><a href="map_generator.html">Markets</a></li>
        <li role="presentation" class="active"><a href="paytv_generator.html">Pay TV</a></li>
        <li role="presentation"><a href="sections_generator.html">Secciones de la app</a></li>
		   <li role="presentation"><a href="push_generator.html">Enviar notificación</a></li>
        <li role="presentation"><a href="index.html"><span class="glyphicon glyphicon-log-out"></span></a></li>
    </ul>
    <h1>Pay TV</h1>

    <div id='editor_holder'></div>
    <a id="downloadAnchorElem" style="display:none"></a>
    <button id='submit' style="color: #555555;">Descargar</button>
    <button id='upload' style="display:none;color: #555555;">Cargar al servidor</button>

    <script>
        $(document).ready(function() {
            $.getJSON("../static/paytv.json", {}, function(data) {
                console.log(data);
                var starting_value = data;
                //console.log(starting_value);
                // Initialize the editor with a JSON schema
                JSONEditor.defaults.options.theme = 'bootstrap3';
                JSONEditor.defaults.options.iconlib = "bootstrap3";

                // SCEditor options
                JSONEditor.plugins.sceditor.emoticonsEnabled = false;
                JSONEditor.plugins.sceditor.toolbar = "bold,italic,underline|source|image";
                //JSONEditor.defaults.language = "es";
                var editor = new JSONEditor(document.getElementById('editor_holder'), {
                    schema: {
                        title: "Agregar a PayTV",
                        type: "array",
                        items: {
                            title: "Seccion",
                            type: "object",
                            headerTemplate: "{{ i1 }} - {{ self.name }}",
                            properties: {
                                name: {
                                    title: "Nombre",
                                    type: "string",
                                    format: "text",
                                },
                                image: {
                                    title: "Imagen",
                                    type: "string",
                                    format: "url",
                                },
                                description: {
                                    title: "Descripcion",
                                    type: "string",
                                    format: "html",
                                    options: {
                                        wysiwyg: true
                                    }
                                }, 
                                target: {
                                    title: "Target",
                                    type: "string",
                                    format: "text",
                                },
                                shows: {
                                    title: "Shows",
                                    type: "string",
                                    format: "text",
                                },
                                coverage: {
                                    title: "Cobertura",
                                    type: "string",
                                    format: "text",
                                }, 
                                trailer: {
                                    title: "Trailer",
                                    type: "string",
                                    format: "text",
                                },   
                            }
                        }
                    },
                    startval: starting_value,
                    disable_colapse: true,
                    disable_properties: true,
                    disable_edit_json: true,
                    show_errors: 'change',
                    required: [
                        "id", "title", "extract", "content"
                    ]
                });

                // Hook up the submit button to log to the console
                document.getElementById('submit').addEventListener('click', function() {
                    // Generate SHA-1 and set as ID
                    var items = editor.getEditor('root').value;
                    for (var i = 0; i < items.length; i++) {
                        var products = editor.getEditor('root').value[i].products;
                        for (var j = 0; j < products.length; j++) {
                            //console.log(sha1(products[j].name));
                            var id = sha1(products[j].name);
                            $("input[name='root[" + i + "][products][" + j + "][id]'").val(id);
                            editor.getEditor('root').value[i].products[j].id = id;
                        }
                    }
                    // Get the value from the editor
                    //console.log(editor.getValue());

                    var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(editor.getValue()));
                    var dlAnchorElem = document.getElementById('downloadAnchorElem');
                    dlAnchorElem.setAttribute("href", dataStr);
                    dlAnchorElem.setAttribute("download", "paytv.json");
                    dlAnchorElem.click();


                });

                $("#upload").click(function(){
                    var accept = confirm("¿Está seguro que desea cargar este archivo? Para deshacer algún cambio deberá volver a cargar el archivo.");
                    if (accept) {
                        var jsonstring = JSON.stringify(editor.getValue());
                        console.log("json a guardar",jsonstring);
                        $.ajax({
                            url: "uploader.php",
                            data: {filename:'paytv.json', json: jsonstring},
                            type: "POST"
                        }).done(function(e) {
                            alert("El archivo fue cargado exitosamente");
                            console.log(e);
                        });
                    }
                });
            });
            if(sessionStorage.getItem("role") == 'super' || sessionStorage.getItem("role") == 'admin') {
                $("#upload").show();
            }
        });
    </script>
</body>

</html>
